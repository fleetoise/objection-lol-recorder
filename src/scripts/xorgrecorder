#!/usr/bin/env bash
set -euo pipefail

DEFAULT_FPS=30
FPS="${1:-$DEFAULT_FPS}"
OUT_DIR="$HOME/Documents/Recordings"

for cmd in gst-launch-1.0 xdotool pactl; do
  if ! command -v "$cmd" &> /dev/null; then
    notify-send "Error: Required command '$cmd' is not installed."
    notify-send "Please install it to continue."
    exit 1
  fi
done

notify-send "Please select the window you want to record by clicking on it."
WINDOW_ID=$(xdotool selectwindow)

if ! [[ "$WINDOW_ID" =~ ^[0-9]+$ ]]; then
    notify-send "Error: Invalid window selection. Please try again."
    exit 1
fi
echo "Selected window ID: $WINDOW_ID" > log.txt

mkdir -p "$OUT_DIR"
timestamp=$(date '+%F_%H-%M-%S')
OUT_FILE="$OUT_DIR/objection_recording_${timestamp}.mp4"

MONITOR_SRC=$(pactl get-default-sink).monitor


gst-launch-1.0 -e \
    ximagesrc window-id="$WINDOW_ID" use-damage=0 ! "video/x-raw,framerate=${FPS}/1" ! \
    videoconvert ! \
    x264enc speed-preset=ultrafast tune=zerolatency ! \
    mp4mux name=mux ! \
    filesink location="$OUT_FILE" \
    pulsesrc device="$MONITOR_SRC" ! \
    audioconvert ! \
    avenc_aac ! \
    mux.

echo "ALL DONE #!#!# SAVED TO $OUT_FILE"
